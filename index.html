<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calendario Turni Aziendale</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        :root { --riposo: #2dce89; --disp: #feb236; --turno: #5e72e4; --bg: #f7f9fe; --text: #32325d; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); padding-bottom: 50px; }
        
        #topBar { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        #calendar { background: white; padding: 5px; border-radius: 15px; margin: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        /* Colori Turni */
        .fc-event { border: none !important; padding: 5px !important; border-radius: 6px !important; font-weight: bold; text-align: center; font-size: 0.85em; }
        .bg-riposo { background-color: var(--riposo) !important; }
        .bg-disp { background-color: var(--disp) !important; }
        .bg-turno { background-color: var(--turno) !important; }
        .bg-modificato { background-color: #f5365c !important; }

        /* Pop-up Modali */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 15% auto; padding: 25px; width: 85%; max-width: 380px; border-radius: 20px; text-align: center; }
        
        .info-box { background: #f0f3ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; text-align: left; border-left: 5px solid var(--turno); }
        select { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
        .btn { padding: 15px 25px; border: none; border-radius: 12px; color: white; cursor: pointer; width: 100%; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .btn-grey { background: #adb5bd; }
        .btn-reset { background: #f5365c; padding: 8px 15px; width: auto; font-size: 11px; margin: 0; }
        
        .turno-info { margin: 15px 0; padding: 10px; border-radius: 8px; background: #f8f9fe; border: 1px solid #eee; }
        .label-small { font-size: 11px; color: #8898aa; text-transform: uppercase; font-weight: bold; }
    </style>
</head>
<body>

<div id="topBar">
    <div>
        <h2 style="margin:0; font-size: 16px;">I Miei Turni</h2>
        <span id="activeRotLabel" style="font-size: 12px; color: var(--turno); font-weight: bold;">Caricamento...</span>
    </div>
    <button class="btn btn-reset" onclick="resetTotale()">RESET APP</button>
</div>

<div id="stepWelcome" class="modal" style="display:block;">
    <div class="modal-content">
        <h3 style="color: var(--turno)">Ciao!</h3>
        <div class="info-box">
            Questa app ti aiuterà a vedere i tuoi turni e riposi in automatico.<br><br>
            Segui i 3 passi guidati per configurare il tuo calendario.
        </div>
        <button class="btn" style="background: var(--turno)" onclick="prossimoStep('stepWelcome', 'stepRotation')">Inizia Configurazione</button>
    </div>
</div>

<div id="stepRotation" class="modal">
    <div class="modal-content">
        <h3>1. Scegli Rotazione</h3>
        <p>In quale gruppo di rotazione sei?</p>
        <select id="rotSelect">
            <option value="rot_fnove">Rotazione F.Nove</option>
            <option value="spez_fnove">Spezzati F.Nove</option>
            <option value="rot_proma">Rotazione P.Roma</option>
            <option value="spez_proma">Spezzati P.Roma</option>
            <option value="rot_szaccaria">Rotazione S.Zaccaria</option>
            <option value="spez_szaccaria">Spezzati S.Zaccaria</option>
            <option value="rot_lido">Rotazione Lido</option>
            <option value="spez_lido">Spezzati Lido</option>
        </select>
        <button class="btn" style="background: var(--turno)" onclick="confermaRotazione()">Avanti</button>
    </div>
</div>

<div id="stepRiposoInfo" class="modal">
    <div class="modal-content">
        <h3>2. Riposo Singolo</h3>
        <div class="info-box">
            Adesso clicca sul calendario il giorno del tuo <b>Riposo Singolo</b> di questo mese.
        </div>
        <button class="btn" style="background: var(--riposo)" onclick="chiudiModali()">Ho capito, clicco il giorno</button>
    </div>
</div>

<div id="stepConfirmRiposo" class="modal">
    <div class="modal-content">
        <h3 id="dateToConfirm">Data</h3>
        <p>Confermi che questo è un giorno di <b>Riposo Singolo</b>?</p>
        <button class="btn" style="background: var(--riposo)" onclick="confermaGiornoRiposo()">Sì, Confermo</button>
        <button class="btn btn-grey" onclick="chiudiModali()">No, ho sbagliato</button>
    </div>
</div>

<div id="stepTurnoDopo" class="modal">
    <div class="modal-content">
        <h3>3. Turno Giorno Dopo</h3>
        <p>Che turno hai il giorno successivo al riposo?</p>
        <select id="turnoDopoSelect"></select>
        <button class="btn" style="background: var(--turno)" onclick="avviaCalendarioFinale()">Salva e Fine</button>
    </div>
</div>

<div id="modalGiorno" class="modal">
    <div class="modal-content">
        <h3 id="viewDate">Data</h3>
        
        <div class="turno-info">
            <span class="label-small">Turno Originale</span>
            <div id="origTurnoText" style="font-size: 20px; font-weight: bold; margin: 5px 0;">-</div>
        </div>

        <div id="cambioBox" class="turno-info" style="border-color: #f5365c; display:none;">
            <span class="label-small" style="color:#f5365c">Turno Attuale (Cambiato)</span>
            <div id="currTurnoText" style="font-size: 20px; font-weight: bold; color:#f5365c;">-</div>
        </div>

        <span class="section-label">Modifica Turno</span>
        <select id="editTurnoSelect"></select>
        <button class="btn" style="background: var(--text)" onclick="salvaCambio()">Salva Modifica</button>
        <button class="btn btn-grey" onclick="resetSingolo()">Ripristina Originale</button>
        <button class="btn btn-grey" style="margin-top:20px" onclick="chiudiModali()">Chiudi</button>
    </div>
</div>

<div id="calendar"></div>

<script>
    const depositi = {
        rot_fnove: ["disp","4p05","4p29","4p07","disp","4p18","4p09","4p04","4p15","disp","4p21","4p34","4p10","4p01","4p06","4p16","4p33","4p39","4p25","4p24","4p32","4p27","4p08","4p11","4p14","disp","4p17","disp","4p37","4p35","4p03","4p23","4p22","4p31","4p02","4p13","disp","4p36","4p38","disp","m204","4p12","m205","4p26","4p20"],
        spez_fnove: ["4p19", "4p28", "4p30"]
    };

    let state = JSON.parse(localStorage.getItem('appTurniState')) || { rot: null, ripSingDate: null, startRotDate: null, turnoIdx: 0, variazioni: {} };
    let selectedDate = null;
    let calendar;

    document.addEventListener('DOMContentLoaded', () => {
        if (!state.rot) {
            document.getElementById('stepWelcome').style.display = 'block';
        } else if (!state.ripSingDate) {
            document.getElementById('stepRiposoInfo').style.display = 'block';
        }
        aggiornaEtichette();
        inizializzaCalendario();
    });

    function prossimoStep(chiudi, apri) {
        document.getElementById(chiudi).style.display = 'none';
        document.getElementById(apri).style.display = 'block';
    }

    function chiudiModali() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }

    function confermaRotazione() {
        state.rot = document.getElementById('rotSelect').value;
        salva();
        aggiornaEtichette();
        prossimoStep('stepRotation', 'stepRiposoInfo');
    }

    function aggiornaEtichette() {
        const sel = document.getElementById('rotSelect');
        document.getElementById('activeRotLabel').innerText = [...sel.options].find(o => o.value === state.rot)?.text || "Configurazione";
        
        // Popola tendina turni per config
        const s = document.getElementById('turnoDopoSelect');
        s.innerHTML = "";
        const lista = (depositi[state.rot] || []).map((t, i) => ({t: t.toUpperCase(), i: i}))
                        .filter(x => x.t !== "DISP")
                        .sort((a,b) => a.t.localeCompare(b.t, undefined, {numeric:true}));
        lista.forEach(item => {
            let o = document.createElement('option'); o.value = item.i; o.textContent = item.t; s.appendChild(o);
        });

        // Popola tendina modifiche
        const se = document.getElementById('editTurnoSelect');
        se.innerHTML = '<option value="RIPOSO">RIPOSO</option><option value="DISPONIBILE">DISPONIBILE</option>';
        let univoci = [];
        for (let d in depositi) { depositi[d].forEach(t => { if(t !== "disp") univoci.push(t.toUpperCase()); }); }
        [...new Set(univoci)].sort((a,b) => a.localeCompare(b, undefined, {numeric:true})).forEach(t => {
            let o = document.createElement('option'); o.value = t; o.textContent = t; se.appendChild(o);
        });
    }

    function inizializzaCalendario() {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth', locale: 'it', firstDay: 1, height: 'auto',
            headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
            dateClick: (info) => gestisciClickData(info.dateStr),
            events: (info, success) => success(generaEventi())
        });
        calendar.render();
    }

    function gestisciClickData(date) {
        selectedDate = date;
        if (!state.rot) { 
            document.getElementById('stepRotation').style.display = 'block';
        } else if (!state.ripSingDate) {
            document.getElementById('dateToConfirm').innerText = date;
            document.getElementById('stepConfirmRiposo').style.display = 'block';
        } else if (!state.startRotDate) {
            // Se è il giorno dopo il riposo
            const ripSec = new Date(state.ripSingDate).getTime();
            const clickSec = new Date(date).getTime();
            if (clickSec === ripSec + 86400000) {
                document.getElementById('stepTurnoDopo').style.display = 'block';
            } else {
                alert("Devi selezionare il giorno DOPO il riposo per configurare i turni.");
            }
        } else {
            apriDettaglio(date);
        }
    }

    function confermaGiornoRiposo() {
        state.ripSingDate = selectedDate;
        salva();
        chiudiModali();
        alert("Ottimo. Ora clicca il giorno immediatamente SUCCESSIVO al riposo per scegliere il turno.");
        calendar.refetchEvents();
    }

    function avviaCalendarioFinale() {
        state.startRotDate = selectedDate;
        state.turnoIdx = parseInt(document.getElementById('turnoDopoSelect').value);
        salva();
        chiudiModali();
        calendar.refetchEvents();
    }

    function generaEventi() {
        if (!state.ripSingDate) return [];
        let evs = [];
        const turni = depositi[state.rot] || [];
        const refRip = Math.floor(new Date(state.ripSingDate).getTime() / 86400000);
        
        for (let i = -60; i < 400; i++) {
            let curSec = (refRip + i) * 86400000;
            let dStr = new Date(curSec).toISOString().split('T')[0];
            
            // Logica Riposi (6+1, 6+2)
            let pos = ((i + 6) % 15 + 15) % 15;
            let isR = (pos === 6 || pos === 13 || pos === 14);
            let tFinal = isR ? "RIPOSO" : "-";

            if (!isR && state.startRotDate) {
                const refStart = Math.floor(new Date(state.startRotDate).getTime() / 86400000);
                if ((refRip + i) >= refStart) {
                    let wDays = 0;
                    for (let j = refStart; j < (refRip + i); j++) {
                        let diffJ = j - refRip;
                        let posJ = ((diffJ + 6) % 15 + 15) % 15;
                        if (!(posJ === 6 || posJ === 13 || posJ === 14)) wDays++;
                    }
                    let idx = (state.turnoIdx + Math.floor(wDays / 2)) % turni.length;
                    tFinal = turni[idx].toUpperCase();
                }
            }

            // Aggiungi evento
            let cName = tFinal === 'RIPOSO' ? 'bg-riposo' : (tFinal === 'DISP' ? 'bg-disp' : 'bg-turno');
            let displayTitle = tFinal;

            // Se c'è variazione
            if (state.variazioni[dStr]) {
                displayTitle = state.variazioni[dStr];
                cName = 'bg-modificato';
            }

            evs.push({ title: displayTitle, start: dStr, className: cName, extendedProps: { originale: tFinal } });
        }
        return evs;
    }

    function apriDettaglio(date) {
        document.getElementById('viewDate').innerText = date;
        const ev = calendar.getEvents().find(e => e.startStr === date);
        const orig = ev ? ev.extendedProps.originale : "-";
        const attuale = state.variazioni[date];

        document.getElementById('origTurnoText').innerText = orig;
        if (attuale) {
            document.getElementById('cambioBox').style.display = 'block';
            document.getElementById('currTurnoText').innerText = attuale;
        } else {
            document.getElementById('cambioBox').style.display = 'none';
        }
        document.getElementById('modalGiorno').style.display = 'block';
    }

    function salvaCambio() {
        state.variazioni[selectedDate] = document.getElementById('editTurnoSelect').value;
        salva();
        chiudiModali();
        calendar.refetchEvents();
    }

    function resetSingolo() {
        delete state.variazioni[selectedDate];
        salva();
        chiudiModali();
        calendar.refetchEvents();
    }

    function salva() { localStorage.setItem('appTurniState', JSON.stringify(state)); }
    function resetTotale() { if(confirm("Vuoi cancellare tutto e rifare la configurazione?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
