<script>
    // DATABASE COMPLETO TURNI
    const turniDB = [
        {s: "4P05", i: "P. Roma 04.55", f: "11.43"}, {s: "4P29", i: "F. Nove 18.04", f: "00.16"},
        {s: "4P07", i: "F. Nove 12.43", f: "19.43"}, {s: "Disp", i: "Disponibile", f: ""},
        {s: "4P18", i: "F. Nove 13.43", f: "20.43"}, {s: "4P09", i: "F. Nove 08.54", f: "15.34"},
        {s: "4P04", i: "F. Nove 04.21", f: "10.34"}, {s: "4P15", i: "F. Nove 15.03", f: "21.41"},
        {s: "Disp", i: "Disponibile", f: ""}, {s: "4P21", i: "F. Nove 06.21", f: "13.23"},
        {s: "4P34", i: "F. Nove 15.01", f: "21.05"}, {s: "4P10", i: "F. Nove 10.01", f: "16.34"},
        {s: "4P01", i: "F. Nove 04.57", f: "11.54"}, {s: "4P06", i: "F. Nove 13.41", f: "20.23"},
        {s: "4P16", i: "F. Nove 11.02", f: "17.03"}, {s: "4P33", i: "F. Nove 04.27", f: "11.14"},
        {s: "Disp", i: "Disponibile", f: ""}, {s: "4P03", i: "F. Nove 04.30", f: "10.33"},
        {s: "4P19", i: "F. Nove 13.51", f: "20.53"}, {s: "4P20", i: "F. Nove 05.51", f: "12.53"},
        {s: "4P11", i: "F. Nove 10.04", f: "16.37"}, {s: "4P31", i: "F. Nove 18.10", f: "00.16"},
        {s: "4P02", i: "F. Nove 04.31", f: "11.23"}, {s: "4P22", i: "F. Nove 06.45", f: "13.43"},
        {s: "Disp", i: "Disponibile", f: ""}, {s: "4P32", i: "F. Nove 18.25", f: "00.32"},
        {s: "4P14", i: "F. Nove 14.54", f: "21.32"}, {s: "4P08", i: "F. Nove 12.54", f: "19.54"},
        {s: "4P12", i: "F. Nove 10.32", f: "17.04"}, {s: "4P25", i: "F. Nove 07.21", f: "14.23"},
        {s: "4P17", i: "F. Nove 11.21", f: "18.23"}, {s: "4P24", i: "F. Nove 07.13", f: "14.12"},
        {s: "Disp", i: "Disponibile", f: ""}, {s: "4P28", i: "F. Nove 17.51", f: "23.51"},
        {s: "4P23", i: "F. Nove 07.01", f: "14.03"}, {s: "4P26", i: "F. Nove 07.41", f: "14.43"},
        {s: "4P30", i: "F. Nove 18.01", f: "00.03"}, {s: "4P27", i: "F. Nove 17.41", f: "23.43"},
        {s: "4P13", i: "F. Nove 14.41", f: "21.23"}, {s: "Disp", i: "Disponibile", f: ""}
    ];

    let state = JSON.parse(localStorage.getItem('myTurniApp')) || { riposoStart: null, rotazioneStart: null, turnoIndex: 0, note: {} };
    let selectedDate = null;

    document.addEventListener('DOMContentLoaded', function() {
        const select = document.getElementById('turnoSelect');
        turniDB.forEach((t, i) => {
            let opt = document.createElement('option');
            opt.value = i;
            opt.textContent = t.s + (t.f ? " (" + t.i + "-" + t.f + ")" : "");
            select.appendChild(opt);
        });

        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'it',
            firstDay: 1,
            headerToolbar: { left: 'prev,next', center: 'title', right: 'today' },
            dateClick: (info) => apriModal(info.dateStr),
            events: calcolaCalendario()
        });
        calendar.render();
    });

    function calcolaCalendario() {
        if (!state.riposoStart) return [];
        let evs = [];
        
        // Data di riferimento (quella che hai cliccato come riposo singolo)
        let refDate = new Date(state.riposoStart);
        refDate.setHours(0,0,0,0);

        // Calcoliamo 6 mesi prima e 6 mesi dopo per coprire il calendario
        let startDate = new Date(refDate); startDate.setMonth(startDate.getMonth() - 6);
        let endDate = new Date(refDate); endDate.setMonth(endDate.getMonth() + 6);

        let curr = new Date(startDate);

        while(curr <= endDate) {
            let dateStr = curr.toISOString().split('T')[0];
            
            // Differenza di giorni tra la data corrente e il riferimento
            let diffDays = Math.round((curr - refDate) / (1000 * 60 * 60 * 24));
            
            // Logica del ciclo di 15 giorni (6L - 1R - 6L - 2R)
            // Facciamo in modo che il giorno di riferimento (diffDays = 0) sia la posizione 6 (il riposo singolo)
            let posCiclo = ((diffDays + 6) % 15 + 15) % 15;

            // Riposi: pos 6 (singolo), pos 13 e 14 (doppio)
            let isRiposo = (posCiclo === 6 || posCiclo === 13 || posCiclo === 14);

            if (isRiposo) {
                evs.push({ title: 'RIPOSO', start: dateStr, className: 'bg-riposo' });
            } else if (state.rotazioneStart) {
                let rotStart = new Date(state.rotazioneStart);
                rotStart.setHours(0,0,0,0);
                
                if (curr >= rotStart) {
                    // Contiamo quanti GIORNI LAVORATIVI sono passati dall'inizio della rotazione
                    let workingDaysCount = 0;
                    let tempDate = new Date(rotStart);
                    while (tempDate < curr) {
                        let dDiff = Math.round((tempDate - refDate) / (1000 * 60 * 60 * 24));
                        let pCiclo = ((dDiff + 6) % 15 + 15) % 15;
                        if (!(pCiclo === 6 || pCiclo === 13 || pCiclo === 14)) workingDaysCount++;
                        tempDate.setDate(tempDate.getDate() + 1);
                    }
                    
                    // Ogni turno ripetuto 2 volte
                    let turnoIdx = (state.turnoIndex + Math.floor(workingDaysCount / 2)) % turniDB.length;
                    let t = turniDB[turnoIdx];
                    evs.push({ 
                        title: t.s + "\n" + t.i + (t.f ? " - " + t.f : ""), 
                        start: dateStr, 
                        className: t.s === 'Disp' ? 'bg-disp' : 'bg-turno' 
                    });
                }
            }
            
            if (state.note[dateStr]) {
                evs.push({ title: "ðŸ“ " + state.note[dateStr], start: dateStr, display: 'list-item', color: '#333' });
            }

            curr.setDate(curr.getDate() + 1);
        }
        return evs;
    }

    function apriModal(date) {
        selectedDate = date;
        document.getElementById('modalDate').textContent = date;
        document.getElementById('notaArea').value = state.note[date] || "";
        document.getElementById('modal').style.display = 'block';
    }

    function chiudiModal() { document.getElementById('modal').style.display = 'none'; }

    function setRiposoSingolo() {
        state.riposoStart = selectedDate;
        state.rotazioneStart = null; // Reset rotazione se cambia il riposo per sicurezza
        salva();
    }

    function avviaRotazione() {
        if (!state.riposoStart) {
            alert("Devi prima impostare un giorno di riposo singolo!");
            return;
        }
        state.rotazioneStart = selectedDate;
        state.turnoIndex = parseInt(document.getElementById('turnoSelect').value);
        salva();
    }

    function salvaNota() {
        state.note[selectedDate] = document.getElementById('notaArea').value;
        salva();
    }

    function salva() {
        localStorage.setItem('myTurniApp', JSON.stringify(state));
        location.reload();
    }
</script>